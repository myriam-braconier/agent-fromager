def create_interface():
    """Interface avec g√©n√©ration simultan√©e"""
    
    fromage_theme = gr.themes.Soft(
        primary_hue="amber",
        secondary_hue="orange",
        neutral_hue="stone"
    )
    
    # CSS (ton code existant)
    custom_css = """
    ... (ton CSS)
    """
    
    with gr.Blocks(title="üßÄ Agent Fromager", theme=fromage_theme, css=custom_css) as demo:
        
        gr.Markdown("""
        # üßÄ Agent Fromager Intelligent
        ### Cr√©ez vos fromages avec l'IA + Recherche web automatique
        """)
        
        # ===== ZONE DE SAISIE COMMUNE EN HAUT =====
        with gr.Row():
            with gr.Column(scale=2):
                ingredients_input = gr.Textbox(
                    label="ü•õ Ingr√©dients disponibles",
                    placeholder="Ex: lait de ch√®vre, pr√©sure, sel, herbes",
                    lines=3
                )
                
                cheese_type_input = gr.Dropdown(
                    choices=[
                        "Laissez l'IA choisir",
                        "Fromage frais",
                        "P√¢te molle",
                        "P√¢te press√©e non cuite",
                        "P√¢te press√©e cuite",
                        "P√¢te persill√©e"
                    ],
                    label="üßÄ Type de fromage",
                    value="Laissez l'IA choisir"
                )
                
                constraints_input = gr.Textbox(
                    label="‚öôÔ∏è Contraintes",
                    placeholder="Ex: v√©g√©tarien, rapide...",
                    lines=2
                )
                
                # Micro-choix
                gr.Markdown("### üéõÔ∏è Micro-choix")
                
                with gr.Row():
                    creativity_slider = gr.Slider(0, 3, value=0, step=1, label="üé® Cr√©ativit√©")
                    texture_choice = gr.Radio(
                        ["Tr√®s cr√©meux", "√âquilibr√©", "Tr√®s ferme"],
                        value="√âquilibr√©",
                        label="üßà Texture"
                    )
                
                with gr.Row():
                    affinage_slider = gr.Slider(0, 12, value=4, step=1, label="‚è±Ô∏è Affinage (semaines)")
                    spice_choice = gr.Radio(
                        ["Neutre", "Mod√©r√©", "Intense"],
                        value="Neutre",
                        label="üå∂Ô∏è √âpices"
                    )
                
                # ===== BOUTON UNIQUE QUI FAIT TOUT =====
                generate_all_btn = gr.Button(
                    "‚ú® G√©n√©rer la recette + Recherche web", 
                    variant="primary", 
                    size="lg"
                )
                
                gr.Markdown("‚è≥ *La g√©n√©ration + recherche web prend 10-15 secondes...*")
            
            with gr.Column(scale=1):
                gr.Markdown("""
                ### üí° Comment √ßa marche ?
                
                1Ô∏è‚É£ Entrez vos ingr√©dients
                2Ô∏è‚É£ Ajustez les micro-choix
                3Ô∏è‚É£ Cliquez sur "G√©n√©rer"
                
                **R√©sultat :**
                - Onglet 1 : Votre recette personnalis√©e
                - Onglet 2 : 6 recettes similaires du web
                
                **Tout se remplit automatiquement !**
                """)
        
        # ===== FONCTIONS POUR L'HISTORIQUE (D√âFINIES AVANT) =====
        def get_recipe_choices():
            """Retourne la liste des noms de recettes pour le Radio"""
            if not agent.history:
                return []
            
            choices = []
            for i, entry in enumerate(agent.history, 1):
                # Extraire le nom de la recette (premi√®re ligne apr√®s "üßÄ")
                lines = entry.split('\n')
                recipe_name = "Recette sans nom"
                for line in lines:
                    if line.strip() and not line.startswith('---') and not line.startswith('üìÖ'):
                        recipe_name = line.strip()[:60]  # Limiter √† 60 caract√®res
                        break
                choices.append(f"{i}. {recipe_name}")
            
            return choices
        
        def show_selected_recipe(selected):
            """Affiche la recette compl√®te s√©lectionn√©e"""
            if not selected or not agent.history:
                return "Aucune recette s√©lectionn√©e"
            
            # Extraire le num√©ro de la recette
            try:
                recipe_num = int(selected.split('.')[0]) - 1
                if 0 <= recipe_num < len(agent.history):
                    return agent.history[recipe_num]
            except:
                pass
            
            return "Erreur lors du chargement de la recette"
        
        def refresh_history():
            """Actualise la liste des recettes"""
            choices = get_recipe_choices()
            if not choices:
                return gr.Radio(choices=["Aucune recette sauvegard√©e"], value=None), ""
            return gr.Radio(choices=choices), ""
        
        def clear_history():
            """Efface l'historique"""
            agent.clear_history()
            return gr.Radio(choices=["Aucune recette sauvegard√©e"], value=None), ""
        
        # ===== ONGLETS POUR AFFICHER LES R√âSULTATS =====
        with gr.Tabs():
            # ONGLET 1 : Recette g√©n√©r√©e
            with gr.Tab("üìñ Ma Recette"):
                recipe_output = gr.Textbox(
                    label="Votre recette compl√®te",
                    lines=30,
                    max_lines=50,
                    placeholder="Votre recette appara√Ætra ici apr√®s g√©n√©ration..."
                )
            
            # ONGLET 2 : Recherche web
            with gr.Tab("üåê Recettes Web (6)"):
                search_status = gr.HTML(label="Statut", value="")
                web_results = gr.HTML(
                    label="R√©sultats",
                    value="<div class='no-recipes'>Cliquez sur 'G√©n√©rer' pour lancer la recherche web...</div>"
                )
            
            # ONGLET 3 : Base de connaissances
            with gr.Tab("üìö Base de connaissances"):
                with gr.Row():
                    knowledge_btn = gr.Button("üìñ Charger r√©sum√© COMPLET", variant="primary")
                
                knowledge_output = gr.Textbox(
                    label="üßÄ SAVOIR FROMAG√àRE COMPLET", 
                    lines=45, 
                    max_lines=60,
                    placeholder="Cliquez pour charger TOUS les types, √©pices, dosages..."
                )
                
                knowledge_btn.click(
                    fn=agent.get_knowledge_summary,
                    outputs=knowledge_output
                )

            # ONGLET 4 : Historique avec visualisation compl√®te
            with gr.Tab("üïí Historique"):
                gr.Markdown("### üìö Vos recettes sauvegard√©es")
                
                with gr.Row():
                    with gr.Column(scale=1):
                        # Liste des recettes - INITIALIS√âE CORRECTEMENT
                        initial_choices = get_recipe_choices()
                        if not initial_choices:
                            initial_choices = ["Aucune recette sauvegard√©e"]
                        
                        history_list = gr.Radio(
                            label="S√©lectionnez une recette",
                            choices=initial_choices,
                            interactive=True
                        )
                        
                        with gr.Row():
                            refresh_btn = gr.Button("üîÑ Actualiser", size="sm")
                            clear_btn = gr.Button("üóëÔ∏è Effacer tout", size="sm", variant="stop")
                    
                    with gr.Column(scale=2):
                        # Affichage de la recette compl√®te
                        selected_recipe_display = gr.Textbox(
                            label="üìñ Recette compl√®te",
                            lines=30,
                            max_lines=50,
                            placeholder="S√©lectionnez une recette dans la liste pour la voir en d√©tail..."
                        )
                
                # Connecter les √©v√©nements
                refresh_btn.click(
                    fn=refresh_history,
                    outputs=[history_list, selected_recipe_display]
                )
                
                clear_btn.click(
                    fn=clear_history,
                    outputs=[history_list, selected_recipe_display]
                )
                
                history_list.change(
                    fn=show_selected_recipe,
                    inputs=history_list,
                    outputs=selected_recipe_display
                )
            
            # ONGLET 5 : Test Internet
            with gr.Tab("üß™ Test Internet"):
                test_btn = gr.Button("üîç Tester")
                test_output = gr.Textbox(lines=5)
                test_btn.click(fn=agent.test_internet, outputs=test_output)
        
        # ===== FONCTION QUI G√âN√àRE LES DEUX EN PARALL√àLE =====
        def generate_all(ingredients, cheese_type, constraints, 
                        creativity, texture, affinage, spice):
            """G√©n√®re recette locale + recherche web simultan√©ment"""
            
            # 1. G√©n√©rer la recette locale
            recipe = agent.generate_recipe_creative(
                ingredients, cheese_type, constraints,
                creativity, texture, affinage, spice
            )
            
            # 2. Rechercher sur le web
            status_html = """
            <div class="search-status">
                üîç Recherche en cours...
            </div>
            """
            
            web_recipes = agent.search_web_recipes(ingredients, cheese_type, max_results=6)
            
            if not web_recipes:
                return recipe, """
                <div class="search-status">
                    ‚úÖ Recherche termin√©e
                </div>
                """, """
                <div class="no-recipes">
                    üòî Aucune recette trouv√©e sur le web pour ces crit√®res.
                </div>
                """
            
            # Construire les cartes HTML
            cards_html = f"""
            <div class="search-status">
                ‚úÖ {len(web_recipes)} recettes trouv√©es sur le web
            </div>
            """
            
            for i, web_recipe in enumerate(web_recipes, 1):
                cards_html += f"""
                <div class="recipe-card">
                    <div class="recipe-title">
                        {i}. {web_recipe['title']}
                    </div>
                    <div class="recipe-source">
                        üìç Source : {web_recipe['source']}
                    </div>
                    <div class="recipe-description">
                        {web_recipe['description']}
                    </div>
                    <a href="{web_recipe['url']}" target="_blank" class="recipe-link">
                        üîó Voir la recette compl√®te
                    </a>
                </div>
                """
            
            return recipe, "", cards_html
        
        # ===== CONNECTER LE BOUTON =====
        generate_all_btn.click(
            fn=generate_all,
            inputs=[
                ingredients_input,
                cheese_type_input,
                constraints_input,
                creativity_slider,
                texture_choice,
                affinage_slider,
                spice_choice
            ],
            outputs=[recipe_output, search_status, web_results]
        )
        
        gr.Markdown("""
        ---
        <center>
        Fait avec üßÄ et ü§ñ | Hugging Face Spaces | 2025
        </center>
        """)
    
    return demo